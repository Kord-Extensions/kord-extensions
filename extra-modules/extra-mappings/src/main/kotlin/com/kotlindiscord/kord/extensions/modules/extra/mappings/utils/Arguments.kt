/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */

package com.kotlindiscord.kord.extensions.modules.extra.mappings.utils

import com.kotlindiscord.kord.extensions.DiscordRelayedException
import com.kotlindiscord.kord.extensions.commands.converters.builders.ConverterBuilder
import com.kotlindiscord.kord.extensions.utils.FilterStrategy
import com.kotlindiscord.kord.extensions.utils.suggestStringMap
import dev.kord.core.entity.interaction.AutoCompleteInteraction
import me.shedaniel.linkie.Namespace
import me.shedaniel.linkie.Namespaces
import me.shedaniel.linkie.namespaces.MojangHashedNamespace
import me.shedaniel.linkie.namespaces.QuiltMappingsNamespace

@PublishedApi
internal const val MAX_RESULTS = 25 // set by Discord's API

/**
 * Define autocomplete for a list of strings.
 * [versions] is a supplier of the list of strings to autocomplete from.
 */
inline fun <reified T> ConverterBuilder<T>.autocompleteVersions(
    crossinline versions: AutoCompleteInteraction.() -> List<String>
) {
    autoComplete {
        val partiallyTyped = focusedOption.value as? String

        val map = versions()
            .filter { it.startsWith(partiallyTyped ?: "") }
            .take(MAX_RESULTS)
            .associateBy { it }

        suggestStringMap(map, FilterStrategy.Contains)
    }
}

/**
 * Turn this [String] into a [Namespace].
 */
@Suppress("TooGenericExceptionCaught") // sorry, but that's what Linkie throws
fun String.toNamespace(): Namespace = when (this) {
    "hashed", "hashed_mojang", "hashed-mojang" -> MojangHashedNamespace
    "quilt-mappings", "quilt" -> QuiltMappingsNamespace
    else -> try {
        Namespaces[this]
    } catch (e: NullPointerException) {
        throw DiscordRelayedException("Invalid namespace: $this")
    }
}
